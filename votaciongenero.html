<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby Shower - ¿Niño o Niña?</title>

    <meta property="og:title" content="Invitación Baby Shower Guzmán Miranda" />
    <meta property="og:description" content="¡Acompáñanos en este día tan especial!" />
    <meta property="og:image" content="https://www.babyshowerguzmanmiranda.com/img/LogoBabyShower.png" />
    <meta property="og:url" content="https://www.babyshowerguzmanmiranda.com/votaciongenero.html" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />

    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/img/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/img/android-chrome-512x512.png">
    <link rel="manifest" href="/img/site.webmanifest">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&family=Kaushan+Script&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Quicksand', sans-serif; }
        
        /* --- Animaciones Generales --- */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        /* --- Animaciones Carrusel --- */
        @keyframes rollOut {
            0% { opacity: 1; transform: translateY(0); max-height: 150px; margin-bottom: 0.75rem; }
            100% { opacity: 0; transform: translateY(-30px); max-height: 0; margin-bottom: 0; padding: 0; border: none; }
        }
        @keyframes rollIn {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-pop { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-roll-out { animation: rollOut 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .animate-roll-in { animation: rollIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        
        .bg-animated {
            background: linear-gradient(-45deg, #f0f9ff, #f5f3ff, #fff1f2, #e0f2fe);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        /* Scrollbar oculta para el carrusel */
        .custom-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }

        /* Estilos Botones */
        .team-btn.selected-boy { border-color: #60a5fa; background-color: #eff6ff; transform: scale(1.05); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1); }
        .team-btn.selected-girl { border-color: #f472b6; background-color: #fdf2f8; transform: scale(1.05); box-shadow: 0 10px 15px -3px rgba(236, 72, 153, 0.1); }
        .team-icon-boy { background-color: #dbeafe; color: #60a5fa; }
        .selected-boy .team-icon-boy { background-color: #3b82f6; color: white; }
        .team-icon-girl { background-color: #fce7f3; color: #f472b6; }
        .selected-girl .team-icon-girl { background-color: #ec4899; color: white; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="min-h-screen bg-animated text-slate-700 overflow-x-hidden relative selection:bg-purple-200">

    <!-- Decoraciones de fondo -->
    <div class="absolute top-0 left-0 w-64 h-64 bg-blue-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-float" style="top: -50px; left: -50px;"></div>
    <div class="absolute bottom-0 right-0 w-64 h-64 bg-pink-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-float" style="animation-delay: 1.5s; bottom: -50px; right: -50px;"></div>

    <div class="container mx-auto px-4 py-8 relative z-10 max-w-4xl">
        
        <!-- Header -->
        <header class="text-center mb-12 animate-pop">
            <div class="inline-flex items-center justify-center p-3 bg-white rounded-full shadow-md mb-4">
                <i data-lucide="sparkles" class="w-5 h-5 text-yellow-400 mr-2"></i>
                <span class="text-sm font-bold text-slate-500 tracking-widest uppercase">Baby Shower Guzmán Miranda</span>
                <i data-lucide="sparkles" class="w-5 h-5 text-yellow-400 ml-2"></i>
            </div>
            <h1 class="text-4xl md:text-6xl font-extrabold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-pink-500">
                ¿Niño o Niña?
            </h1>
            <p class="text-lg text-slate-600 mb-6">¡Adivina y déjanos tus mejores deseos!</p>
        </header>

        <!-- Formulario de Votación -->
        <div id="voteSection" class="bg-white/80 backdrop-blur-md rounded-3xl shadow-xl p-6 md:p-10 mb-12 border border-white animate-pop duration-700">
            <h2 class="text-2xl font-bold text-center mb-8 text-slate-800">¡Haz tu predicción!</h2>
            
            <form id="votingForm" class="space-y-8">
                <!-- Selector de Equipo -->
                <div class="grid grid-cols-2 gap-4 md:gap-8">
                    <!-- Botón Niño -->
                    <button type="button" id="btnBoy" class="team-btn relative group flex flex-col items-center p-6 rounded-2xl border-2 border-slate-100 hover:border-blue-200 bg-white hover:bg-blue-50/50 transition-all duration-300">
                        <div class="team-icon-boy w-16 h-16 rounded-full flex items-center justify-center mb-3 transition-colors">
                            <i data-lucide="baby" class="w-8 h-8"></i>
                        </div>
                        <span class="team-text font-bold text-lg text-slate-500 group-hover:text-blue-500 transition-colors">Team Niño</span>
                        <div class="check-icon absolute -top-2 -right-2 bg-blue-500 text-white p-1 rounded-full hidden">
                            <i data-lucide="check" class="w-4 h-4"></i>
                        </div>
                    </button>

                    <!-- Botón Niña -->
                    <button type="button" id="btnGirl" class="team-btn relative group flex flex-col items-center p-6 rounded-2xl border-2 border-slate-100 hover:border-pink-200 bg-white hover:bg-pink-50/50 transition-all duration-300">
                        <div class="team-icon-girl w-16 h-16 rounded-full flex items-center justify-center mb-3 transition-colors">
                            <i data-lucide="heart" class="w-8 h-8"></i>
                        </div>
                        <span class="team-text font-bold text-lg text-slate-500 group-hover:text-pink-500 transition-colors">Team Niña</span>
                        <div class="check-icon absolute -top-2 -right-2 bg-pink-500 text-white p-1 rounded-full hidden">
                            <i data-lucide="check" class="w-4 h-4"></i>
                        </div>
                    </button>
                </div>

                <!-- Inputs -->
                <div class="space-y-4 max-w-md mx-auto">
                    <div class="relative group">
                        <div class="absolute top-3.5 left-3 text-slate-400 group-focus-within:text-purple-500 transition-colors">
                            <i data-lucide="user" class="w-5 h-5"></i>
                        </div>
                        <input type="text" id="inputName" placeholder="Tu nombre completo" required
                            class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:border-purple-400 focus:ring focus:ring-purple-200 transition-all outline-none bg-white/50">
                    </div>
                    <div class="relative group">
                        <div class="absolute top-3.5 left-3 text-slate-400 group-focus-within:text-purple-500 transition-colors">
                            <i data-lucide="message-circle" class="w-5 h-5"></i>
                        </div>
                        <textarea id="inputMessage" placeholder="Un mensaje bonito para el bebé (opcional)"
                            class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:border-purple-400 focus:ring focus:ring-purple-200 transition-all outline-none bg-white/50 min-h-[80px]"></textarea>
                    </div>
                    
                    <!-- Mensaje de Error -->
                    <div id="errorMessage" class="hidden p-3 bg-red-100 border border-red-200 text-red-600 rounded-xl text-sm text-center font-bold"></div>
                </div>

                <!-- Botón Submit -->
                <div class="text-center">
                    <button type="submit" id="submitBtn" disabled
                        class="px-8 py-4 rounded-full font-bold text-white text-lg shadow-lg transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center mx-auto min-w-[200px] bg-slate-300 cursor-not-allowed">
                        <span>Enviar mi Voto</span>
                        <i data-lucide="send" class="ml-2 w-5 h-5"></i>
                    </button>
                </div>
            </form>
        </div>

        <!-- Mensaje de Gracias (Oculto por defecto) -->
        <div id="thankYouSection" class="hidden text-center mb-12 animate-pop bg-white/60 backdrop-blur p-8 rounded-2xl border border-white shadow-lg">
            <div class="inline-block p-3 bg-green-100 rounded-full text-green-500 mb-4">
                <i data-lucide="check-circle" class="w-8 h-8"></i>
            </div>
            <h3 class="text-2xl font-bold text-slate-700 mb-2">¡Gracias por participar!</h3>
            <p class="text-slate-500 mb-4">Tu voto ha sido registrado.</p>
            <button onclick="location.reload()" class="text-blue-500 font-bold underline text-sm hover:text-blue-700">
                Votar otra vez
            </button>
        </div>

        <!-- Sección de Resultados (CARRUSEL) -->
        <div class="space-y-8 animate-pop">
            
            <div class="flex items-center justify-between">
                <h3 class="font-bold text-slate-600 text-lg ml-2">Resultados Actuales</h3>
                <button onclick="cargarDatos()" class="text-xs bg-white/50 px-3 py-1 rounded-full hover:bg-white text-slate-500 flex items-center transition-transform active:scale-95 cursor-pointer">
                    <i data-lucide="refresh-cw" class="w-3 h-3 mr-1"></i> Actualizar
                </button>
            </div>

            <!-- Barra de Progreso VS -->
            <div class="bg-white rounded-3xl p-2 shadow-lg overflow-hidden relative">
                <div class="flex h-14 md:h-16 rounded-2xl overflow-hidden relative bg-slate-100">
                    <!-- Barra Azul -->
                    <div id="barBoy" class="bg-blue-400 flex items-center justify-start pl-4 transition-all duration-1000 relative w-1/2">
                        <span id="txtBoyPercent" class="text-white font-bold whitespace-nowrap z-10 drop-shadow-md text-sm md:text-base">0% Niño</span>
                        <div class="absolute inset-0 opacity-20" style="background-image: url('https://www.transparenttextures.com/patterns/diagonal-stripes.png');"></div>
                    </div>

                    <!-- Barra Rosa -->
                    <div id="barGirl" class="bg-pink-400 flex items-center justify-end pr-4 transition-all duration-1000 relative w-1/2">
                        <span id="txtGirlPercent" class="text-white font-bold whitespace-nowrap z-10 drop-shadow-md text-sm md:text-base">0% Niña</span>
                        <div class="absolute inset-0 opacity-20" style="background-image: url('https://www.transparenttextures.com/patterns/diagonal-stripes.png');"></div>
                    </div>
                    
                    <!-- VS Badge -->
                    <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg font-bold text-xs text-slate-400 z-20 border-4 border-white">
                        VS
                    </div>
                </div>
            </div>

            <!-- Listas de Votos (Carrusel) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Columna Niño -->
                <div class="bg-blue-50/60 rounded-3xl p-4 border border-blue-100 backdrop-blur-sm">
                    <div class="flex items-center justify-center mb-4 text-blue-500">
                        <i data-lucide="baby" class="w-5 h-5 mr-2"></i>
                        <h3 class="font-bold text-lg">Team Niño (<span id="countBoy">0</span>)</h3>
                    </div>
                    <!-- Contenedor Carrusel: Altura fija y overflow hidden para la animación -->
                    <div id="listBoy" class="h-80 overflow-hidden relative flex flex-col gap-3 p-1">
                        <div class="text-center text-blue-400 text-sm py-4">Cargando...</div>
                    </div>
                </div>

                <!-- Columna Niña -->
                <div class="bg-pink-50/60 rounded-3xl p-4 border border-pink-100 backdrop-blur-sm">
                    <div class="flex items-center justify-center mb-4 text-pink-500">
                        <i data-lucide="heart" class="w-5 h-5 mr-2"></i>
                        <h3 class="font-bold text-lg">Team Niña (<span id="countGirl">0</span>)</h3>
                    </div>
                    <div id="listGirl" class="h-80 overflow-hidden relative flex flex-col gap-3 p-1">
                        <div class="text-center text-pink-400 text-sm py-4">Cargando...</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getDatabase, ref, push, serverTimestamp, get, goOffline, goOnline } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js';

        // Configuración REAL
        const firebaseConfig = {
            apiKey: "AIzaSyDDJ0UmA5giAjFbz54JqaudKFOBfEv613U",
            authDomain: "babyshowerguzmanmiranda.firebaseapp.com",
            databaseURL: "https://babyshowerguzmanmiranda-default-rtdb.firebaseio.com",
            projectId: "babyshowerguzmanmiranda",
            storageBucket: "babyshowerguzmanmiranda.firebasestorage.app",
            messagingSenderId: "564665563453",
            appId: "1:564665563453:web:242aaba73a4768fa89ad54",
            measurementId: "G-DJHTP10XY0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- Estado Global ---
        let currentUser = null;
        let selectedTeam = null;
        let hasVoted = false;

        // Datos para carrusel (en memoria)
        let allBoyVotes = [];
        let allGirlVotes = [];
        let boyNextIndex = 0;
        let girlNextIndex = 0;
        let carouselInterval = null;

        // Elementos UI
        const voteSection = document.getElementById('voteSection');
        const thankYouSection = document.getElementById('thankYouSection');
        const form = document.getElementById('votingForm');
        const submitBtn = document.getElementById('submitBtn');
        const inputName = document.getElementById('inputName');
        const inputMessage = document.getElementById('inputMessage');
        const btnBoy = document.getElementById('btnBoy');
        const btnGirl = document.getElementById('btnGirl');
        const errorMessage = document.getElementById('errorMessage');

        // --- NUEVA FUNCIÓN DE NORMALIZACIÓN ---
        function normalizarTexto(texto) {
            if (!texto) return '';
            return texto
                .normalize("NFD") // Descompone caracteres con acento
                .replace(/[\u0300-\u036f]/g, "") // Elimina los acentos
                .toUpperCase() // Convierte a mayúsculas
                .replace(/[^A-Z0-9]/g, ""); // Elimina todo lo que no sea letra o número (espacios, comas, etc.)
        }

        // --- Carga de Datos y Carrusel (No Realtime) ---
        window.cargarDatos = async function() {
            console.log("Conectando para actualizar...");
            goOnline(db);

            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                currentUser = auth.currentUser;

                const snapshot = await get(ref(db, 'votaciones'));
                const votes = [];
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    Object.keys(data).forEach(key => {
                        votes.push({ id: key, ...data[key] });
                    });
                }

                // Ordenar por fecha
                votes.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

                // Actualizar arrays en memoria
                allBoyVotes = votes.filter(v => v.team === 'boy');
                allGirlVotes = votes.filter(v => v.team === 'girl');

                // Actualizar Estadísticas
                updateStats(votes.length, allBoyVotes.length, allGirlVotes.length);
                
                // Inicializar listas
                inicializarOActualizar('listBoy', allBoyVotes, 'blue');
                inicializarOActualizar('listGirl', allGirlVotes, 'pink');

                // Iniciar ciclo si no existe
                if (!carouselInterval) {
                    carouselInterval = setInterval(runCarouselStep, 3500);
                }

            } catch (error) {
                console.error("Error cargando datos:", error);
                document.getElementById('listBoy').innerHTML = '<div class="text-center text-red-300 text-sm py-4">Error de conexión</div>';
                document.getElementById('listGirl').innerHTML = '<div class="text-center text-red-300 text-sm py-4">Error de conexión</div>';
            } finally {
                console.log("Datos cargados. Desconectando.");
                goOffline(db);
            }
        }

        function updateStats(total, boyCount, girlCount) {
            let boyPercent = total === 0 ? 50 : (boyCount / total) * 100;
            let girlPercent = total === 0 ? 50 : (girlCount / total) * 100;

            document.getElementById('barBoy').style.width = `${boyPercent}%`;
            document.getElementById('barGirl').style.width = `${girlPercent}%`;
            document.getElementById('txtBoyPercent').innerText = `${Math.round(boyPercent)}% Niño`;
            document.getElementById('txtGirlPercent').innerText = `${Math.round(girlPercent)}% Niña`;
            document.getElementById('countBoy').innerText = boyCount;
            document.getElementById('countGirl').innerText = girlCount;
        }

        // --- Funciones del Carrusel ---

        function inicializarOActualizar(containerId, allVotes, color) {
            const container = document.getElementById(containerId);
            
            if (allVotes.length === 0) {
                if (container.children.length === 0 || !container.innerHTML.includes('Aún no hay')) {
                     container.innerHTML = `<div class="text-center text-${color}-400 text-sm py-8">Aún no hay votos.</div>`;
                }
                return;
            }

            if (container.innerText.includes('Cargando') || container.innerText.includes('Aún no hay')) {
                container.innerHTML = '';
            }

            // Llenar inicial (hasta 3)
            if (container.children.length === 0) {
                const initialToShow = allVotes.slice(0, 3);
                initialToShow.forEach(vote => createCard(container, vote, color));
                
                const type = color === 'blue' ? 'boy' : 'girl';
                const nextIdx = initialToShow.length % allVotes.length;
                if (type === 'boy') boyNextIndex = nextIdx; else girlNextIndex = nextIdx;
                return;
            }

            // Modo estático (<= 3): agregar nuevos si faltan
            if (allVotes.length <= 3) {
                const currentIds = Array.from(container.children).map(el => el.dataset.id);
                allVotes.forEach(vote => {
                    if (!currentIds.includes(vote.id)) {
                        createCard(container, vote, color);
                    }
                });
            }
        }

        function runCarouselStep() {
            stepColumn('listBoy', allBoyVotes, 'blue', 'boy');
            setTimeout(() => stepColumn('listGirl', allGirlVotes, 'pink', 'girl'), 500);
        }

        function stepColumn(containerId, allVotes, color, type) {
            if (allVotes.length <= 3) return; // Modo estático

            const container = document.getElementById(containerId);
            const currentCards = container.children;
            
            if (currentCards.length === 0) {
                inicializarOActualizar(containerId, allVotes, color);
                return;
            }

            let nextIndex = (type === 'boy') ? boyNextIndex : girlNextIndex;
            const nextVote = allVotes[nextIndex];

            // Avanzar índice circularmente
            if (type === 'boy') boyNextIndex = (boyNextIndex + 1) % allVotes.length;
            else girlNextIndex = (girlNextIndex + 1) % allVotes.length;

            // Animación Salida (Top)
            const cardToRemove = currentCards[0];
            cardToRemove.classList.remove('animate-roll-in');
            cardToRemove.classList.add('animate-roll-out');
            
            setTimeout(() => {
                if (cardToRemove.parentNode === container) container.removeChild(cardToRemove);
            }, 750);

            // Animación Entrada (Bottom)
            createCard(container, nextVote, color);
        }

        function createCard(container, vote, color) {
            const card = document.createElement('div');
            card.dataset.id = vote.id;
            card.className = `flex-shrink-0 bg-white p-4 rounded-xl shadow-sm border-l-4 border-${color}-400 animate-roll-in mb-3`;
            
            const nameEl = document.createElement('div');
            nameEl.className = 'font-bold text-slate-700';
            nameEl.innerText = vote.name;
            card.appendChild(nameEl);

            if (vote.message) {
                const msgEl = document.createElement('div');
                msgEl.className = 'text-sm text-slate-500 mt-1 italic line-clamp-2 overflow-hidden text-ellipsis';
                msgEl.innerText = `"${vote.message}"`;
                card.appendChild(msgEl);
            }
            container.appendChild(card);
        }

        // --- UI FORMULARIO ---

        function showThankYou() {
            voteSection.classList.add('hidden');
            thankYouSection.classList.remove('hidden');
        }

        function updateSubmitButton() {
            const nameValid = inputName.value.trim().length > 0;
            const teamValid = selectedTeam !== null;
            
            if (nameValid && teamValid && !hasVoted) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-slate-300', 'cursor-not-allowed');
                submitBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-pink-500', 'hover:shadow-xl');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('bg-slate-300', 'cursor-not-allowed');
                submitBtn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-pink-500', 'hover:shadow-xl');
            }
        }

        btnBoy.addEventListener('click', () => {
            selectedTeam = 'boy';
            btnBoy.classList.add('selected-boy');
            btnBoy.querySelector('.check-icon').classList.remove('hidden');
            btnGirl.classList.remove('selected-girl');
            btnGirl.querySelector('.check-icon').classList.add('hidden');
            updateSubmitButton();
        });

        btnGirl.addEventListener('click', () => {
            selectedTeam = 'girl';
            btnGirl.classList.add('selected-girl');
            btnGirl.querySelector('.check-icon').classList.remove('hidden');
            btnBoy.classList.remove('selected-boy');
            btnBoy.querySelector('.check-icon').classList.add('hidden');
            updateSubmitButton();
        });

        inputName.addEventListener('input', () => {
            errorMessage.classList.add('hidden');
            updateSubmitButton();
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedTeam) return;

            const nameOriginal = inputName.value.trim();
            // Usar la nueva normalización
            const nameNorm = normalizarTexto(nameOriginal);
            const message = inputMessage.value.trim();

            submitBtn.innerHTML = 'Verificando...';
            submitBtn.disabled = true;
            errorMessage.classList.add('hidden');

            goOnline(db);

            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                currentUser = auth.currentUser;

                // Validar duplicado
                const snapshot = await get(ref(db, 'votaciones'));
                let yaVoto = false;
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    Object.values(data).forEach(voto => {
                        if (voto.nombreNormalizado === nameNorm) yaVoto = true;
                    });
                }

                if (yaVoto) {
                    errorMessage.innerText = `El nombre "${nameOriginal}" ya registró un voto anteriormente.`;
                    errorMessage.classList.remove('hidden');
                    submitBtn.innerHTML = 'Enviar mi Voto';
                    submitBtn.disabled = false;
                    if (snapshot.exists()) cargarDatos();
                } else {
                    submitBtn.innerHTML = 'Enviando...';
                    await push(ref(db, 'votaciones'), {
                        name: nameOriginal,
                        nombreNormalizado: nameNorm,
                        message: message,
                        team: selectedTeam,
                        userId: currentUser.uid,
                        timestamp: serverTimestamp()
                    });
                    showThankYou();
                    cargarDatos();
                }
            } catch (error) {
                console.error(error);
                submitBtn.innerHTML = 'Error. Reintentar';
                submitBtn.disabled = false;
            }
        });

        // Iniciar
        cargarDatos();
        lucide.createIcons();
        
    </script>
</body>
</html>