<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados en Vivo</title>
    
    <meta property="og:title" content="Invitación Baby Shower Guzmán Miranda" />
    <meta property="og:description" content="¡Acompáñanos en este día tan especial!" />
    <meta property="og:image" content="https://www.babyshowerguzmanmiranda.com/img/LogoBabyShower.png" />
    <meta property="og:url" content="https://www.babyshowerguzmanmiranda.com/resultadosvotaciones.html" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />

    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/img/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/img/android-chrome-512x512.png">
    <link rel="manifest" href="/img/site.webmanifest">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&family=Kaushan+Script&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Quicksand', sans-serif; }
        
        /* Animación de SALIDA (El elemento de arriba se va) */
        @keyframes rollOut {
            0% { opacity: 1; transform: translateY(0); max-height: 150px; margin-bottom: 0.75rem; }
            100% { opacity: 0; transform: translateY(-30px); max-height: 0; margin-bottom: 0; padding: 0; border: none; }
        }

        /* Animación de ENTRADA (El nuevo elemento llega desde abajo) */
        @keyframes rollIn {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .animate-roll-out { animation: rollOut 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .animate-roll-in { animation: rollIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        
        @keyframes gradientBG { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }
        
        .bg-animated {
            background: linear-gradient(-45deg, #f0f9ff, #f5f3ff, #fff1f2, #e0f2fe);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="min-h-screen bg-animated text-slate-700 overflow-hidden relative selection:bg-purple-200">

    <div class="container mx-auto px-4 py-6 relative z-10 max-w-6xl h-screen flex flex-col">
        
        <!-- Header -->
        <header class="text-center mb-4 flex-shrink-0">
            <h1 class="text-4xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-pink-500 mb-1">
                Resultados en Vivo
            </h1>
            <p class="text-lg text-slate-600">¡Mira quién está ganando!</p>
        </header>

        <!-- Barra de Progreso -->
        <div class="bg-white rounded-3xl p-3 shadow-xl overflow-hidden relative mb-6 transform hover:scale-[1.01] transition-transform flex-shrink-0">
            <div class="flex h-20 rounded-2xl overflow-hidden relative bg-slate-100">
                <!-- Barra Azul -->
                <div id="barBoy" class="bg-blue-400 flex items-center justify-start pl-6 transition-all duration-1000 relative w-1/2">
                    <div class="z-10 drop-shadow-md">
                        <div class="text-3xl font-black text-white" id="txtBoyPercent">50%</div>
                        <div class="text-blue-100 text-sm font-bold uppercase tracking-wider">Team Niño</div>
                    </div>
                    <div class="absolute inset-0 opacity-20" style="background-image: url('https://www.transparenttextures.com/patterns/diagonal-stripes.png');"></div>
                </div>

                <!-- Barra Rosa -->
                <div id="barGirl" class="bg-pink-400 flex items-center justify-end pr-6 transition-all duration-1000 relative w-1/2">
                    <div class="z-10 drop-shadow-md text-right">
                        <div class="text-3xl font-black text-white" id="txtGirlPercent">50%</div>
                        <div class="text-pink-100 text-sm font-bold uppercase tracking-wider">Team Niña</div>
                    </div>
                    <div class="absolute inset-0 opacity-20" style="background-image: url('https://www.transparenttextures.com/patterns/diagonal-stripes.png');"></div>
                </div>
                
                <!-- VS Badge -->
                <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-full w-14 h-14 flex items-center justify-center shadow-2xl font-black text-xl text-slate-300 z-20 border-4 border-white">
                    VS
                </div>
            </div>
        </div>

        <!-- Listas de Votos -->
        <div class="grid grid-cols-2 gap-6 flex-1 overflow-hidden pb-2">
            
            <!-- Columna Niño -->
            <div class="bg-blue-50/80 rounded-3xl p-4 border-2 border-blue-100 backdrop-blur-md flex flex-col h-full shadow-lg">
                <div class="flex items-center justify-center mb-3 pb-3 border-b border-blue-200 flex-shrink-0">
                    <div class="bg-blue-100 p-2 rounded-full mr-3 text-blue-500"><i data-lucide="baby" class="w-6 h-6"></i></div>
                    <div>
                        <h3 class="font-black text-2xl text-blue-600">NIÑO</h3>
                        <p class="text-blue-400 font-bold text-sm"><span id="countBoy">0</span> votos</p>
                    </div>
                </div>
                <div id="listBoy" class="flex-1 flex flex-col justify-start overflow-hidden relative p-1 gap-3">
                    <div class="text-center text-blue-300 mt-10 text-lg animate-pulse">Cargando datos...</div>
                </div>
            </div>

            <!-- Columna Niña -->
            <div class="bg-pink-50/80 rounded-3xl p-4 border-2 border-pink-100 backdrop-blur-md flex flex-col h-full shadow-lg">
                <div class="flex items-center justify-center mb-3 pb-3 border-b border-pink-200 flex-shrink-0">
                    <div class="bg-pink-100 p-2 rounded-full mr-3 text-pink-500"><i data-lucide="heart" class="w-6 h-6"></i></div>
                    <div>
                        <h3 class="font-black text-2xl text-pink-600">NIÑA</h3>
                        <p class="text-pink-400 font-bold text-sm"><span id="countGirl">0</span> votos</p>
                    </div>
                </div>
                <div id="listGirl" class="flex-1 flex flex-col justify-start overflow-hidden relative p-1 gap-3">
                    <div class="text-center text-pink-300 mt-10 text-lg animate-pulse">Cargando datos...</div>
                </div>
            </div>

        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDDJ0UmA5giAjFbz54JqaudKFOBfEv613U",
            authDomain: "babyshowerguzmanmiranda.firebaseapp.com",
            databaseURL: "https://babyshowerguzmanmiranda-default-rtdb.firebaseio.com",
            projectId: "babyshowerguzmanmiranda",
            storageBucket: "babyshowerguzmanmiranda.firebasestorage.app",
            messagingSenderId: "564665563453",
            appId: "1:564665563453:web:242aaba73a4768fa89ad54"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        let allBoyVotes = [];
        let allGirlVotes = [];
        let carouselInterval = null;

        async function initAuth() {
            try { await signInAnonymously(auth); } catch (e) { console.error(e); }
        }
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) listenToVotes();
        });

        function listenToVotes() {
            const votosRef = ref(db, 'votaciones');
            
            onValue(votosRef, (snapshot) => {
                const data = snapshot.val();
                const votes = [];
                
                if (data) {
                    Object.keys(data).forEach(key => {
                        votes.push({ id: key, ...data[key] });
                    });
                }
                
                // Ordenar por timestamp (1, 2, 3...)
                votes.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                
                allBoyVotes = votes.filter(v => v.team === 'boy');
                allGirlVotes = votes.filter(v => v.team === 'girl');
                
                // 1. Actualizar Barras y Contadores
                updateStats(votes.length, allBoyVotes.length, allGirlVotes.length);

                // 2. Inicializar o actualizar vista
                // IMPORTANTE: Esta función ahora maneja tanto el caso <= 3 como el inicio de > 3
                inicializarOActualizar('listBoy', allBoyVotes, 'blue');
                inicializarOActualizar('listGirl', allGirlVotes, 'pink');

                // 3. Iniciar Carrusel si no existe
                if (!carouselInterval) {
                    carouselInterval = setInterval(runCarouselStep, 3000);
                }
            });
        }

        function updateStats(total, boyCount, girlCount) {
            let boyPercent = total === 0 ? 50 : (boyCount / total) * 100;
            let girlPercent = total === 0 ? 50 : (girlCount / total) * 100;

            document.getElementById('barBoy').style.width = `${boyPercent}%`;
            document.getElementById('barGirl').style.width = `${girlPercent}%`;
            document.getElementById('txtBoyPercent').innerText = `${Math.round(boyPercent)}%`;
            document.getElementById('txtGirlPercent').innerText = `${Math.round(girlPercent)}%`;
            document.getElementById('countBoy').innerText = boyCount;
            document.getElementById('countGirl').innerText = girlCount;
        }

        // Función unificada para asegurar que la lista tenga elementos
        function inicializarOActualizar(containerId, allVotes, color) {
            const container = document.getElementById(containerId);
            
            // Caso 0 votos
            if (allVotes.length === 0) {
                if (container.children.length === 0 || !container.innerHTML.includes('Esperando')) {
                     container.innerHTML = `<div class="text-center text-${color}-300 mt-10 text-lg animate-pulse">Esperando votos...</div>`;
                }
                return;
            }

            // Limpiar mensaje de carga
            if (container.innerText.includes('Cargando') || container.innerText.includes('Esperando')) {
                container.innerHTML = '';
            }

            // Si el contenedor está vacío (inicio), lo llenamos con los primeros 3 (o menos)
            if (container.children.length === 0) {
                const initialToShow = allVotes.slice(0, 3);
                initialToShow.forEach(vote => createCard(container, vote, color));
                return;
            }

            // Si es Modo Estático (<= 3), aseguramos que todos los nuevos aparezcan
            if (allVotes.length <= 3) {
                const currentIds = Array.from(container.children).map(el => el.dataset.id);
                allVotes.forEach(vote => {
                    if (!currentIds.includes(vote.id)) {
                        createCard(container, vote, color);
                    }
                });
            }
            // Si es > 3, el setInterval se encargará de rotar, no hacemos nada aquí para no interrumpir la animación
        }

        function runCarouselStep() {
            stepColumn('listBoy', allBoyVotes, 'blue');
            setTimeout(() => stepColumn('listGirl', allGirlVotes, 'pink'), 500);
        }

        function stepColumn(containerId, allVotes, color) {
            // Solo rotar si hay más de 3 votos
            if (allVotes.length <= 3) return; 

            const container = document.getElementById(containerId);
            const currentCards = container.children;
            
            // Seguridad: Si por alguna razón se vació, re-inicializar
            if (currentCards.length === 0) {
                inicializarOActualizar(containerId, allVotes, color);
                return;
            }

            // 1. Identificar cuál sigue en la secuencia
            // Miramos el último elemento en el DOM para saber qué sigue
            const lastCardId = currentCards[currentCards.length - 1].dataset.id;
            const lastIndexInList = allVotes.findIndex(v => v.id === lastCardId);
            
            // Índice circular
            const nextIndex = (lastIndexInList + 1) % allVotes.length;
            const nextVote = allVotes[nextIndex];

            // 2. Animación de Salida (Top)
            const cardToRemove = currentCards[0];
            cardToRemove.classList.remove('animate-roll-in');
            cardToRemove.classList.add('animate-roll-out');
            
            setTimeout(() => {
                if (cardToRemove.parentNode === container) container.removeChild(cardToRemove);
            }, 750);

            // 3. Animación de Entrada (Bottom)
            createCard(container, nextVote, color);
        }

        function createCard(container, vote, color) {
            const card = document.createElement('div');
            card.dataset.id = vote.id;
            card.className = `flex-shrink-0 bg-white p-4 rounded-2xl shadow-sm border-l-8 border-${color}-400 animate-roll-in mb-3`;
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex justify-between items-center';
            
            const nameEl = document.createElement('div');
            nameEl.className = 'font-bold text-xl text-slate-700 truncate';
            nameEl.innerText = vote.name;
            headerDiv.appendChild(nameEl);
            card.appendChild(headerDiv);

            if (vote.message) {
                const msgEl = document.createElement('div');
                msgEl.className = 'text-base text-slate-500 mt-2 italic line-clamp-2 overflow-hidden text-ellipsis';
                msgEl.innerText = `"${vote.message}"`;
                card.appendChild(msgEl);
            }
            container.appendChild(card);
        }

        lucide.createIcons();
    </script>
</body>
</html>